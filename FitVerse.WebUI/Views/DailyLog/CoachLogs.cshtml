@model IEnumerable<FitVerse.Data.Models.DailyLog>

@{
    ViewData["Title"] = "Client Daily Logs";
    Layout = "~/Views/Shared/_CoachLayout.cshtml";
}

<!-- Main Content -->
<div class="container-fluid px-4 py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">
                <i class="bi bi-journal-text me-2 text-primary"></i>Client Daily Logs
            </h2>
            <p class="text-muted mb-0">Review and respond to your clients' daily progress logs</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary modern-btn" id="refreshLogsBtn">
                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </button>
            <div class="dropdown">
                <button class="btn btn-secondary modern-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-funnel me-2"></i>Filter
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-filter="all">All Logs</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="pending">Pending Review</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="reviewed">Reviewed</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row g-4 mb-4" id="logsStats">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card modern-stat-card">
                <div class="stat-icon-wrapper">
                    <div class="stat-icon primary">
                        <i class="bi bi-journal-text"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalLogsCount">@Model.Count()</div>
                    <div class="stat-label">Total Logs</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card modern-stat-card">
                <div class="stat-icon-wrapper">
                    <div class="stat-icon warning">
                        <i class="bi bi-clock-history"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="pendingLogsCount">@Model.Count(l => !l.IsReviewed)</div>
                    <div class="stat-label">Pending Review</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card modern-stat-card">
                <div class="stat-icon-wrapper">
                    <div class="stat-icon success">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="reviewedLogsCount">@Model.Count(l => l.IsReviewed)</div>
                    <div class="stat-label">Reviewed</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card modern-stat-card">
                <div class="stat-icon-wrapper">
                    <div class="stat-icon info">
                        <i class="bi bi-star"></i>
                    </div>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="avgRatingCount">
                        @{
                            var reviewedLogs = Model.Where(l => l.IsReviewed && l.CoachRating.HasValue);
                            var avgRating = reviewedLogs.Any() ? reviewedLogs.Average(l => l.CoachRating.Value) : 0;
                        }
                        @avgRating.ToString("F1")
                    </div>
                    <div class="stat-label">Avg Rating</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="card modern-card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-lg-6">
                    <div class="search-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="form-control modern-search-input" id="logSearchInput" 
                               placeholder="Search logs by client name, notes, or date...">
                    </div>
                </div>
                <div class="col-lg-3">
                    <select class="form-select modern-form-control" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending Review</option>
                        <option value="reviewed">Reviewed</option>
                    </select>
                </div>
                <div class="col-lg-3">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary modern-btn flex-fill" id="clearFiltersBtn">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </button>
                        <div class="view-toggle">
                            <button class="btn btn-outline-primary modern-btn active" id="cardViewBtn" title="Card View">
                                <i class="bi bi-grid-3x3-gap"></i>
                            </button>
                            <button class="btn btn-outline-primary modern-btn" id="listViewBtn" title="List View">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="text-center py-5" id="loadingState" style="display: none;">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted">Loading daily logs...</p>
    </div>

    <!-- Empty State -->
    <div class="text-center py-5" id="emptyState" style="display: none;">
        <div class="empty-state-icon mb-3">
            <i class="bi bi-journal-text text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="text-muted mb-2">No Daily Logs Found</h4>
        <p class="text-muted mb-4">No client daily logs match your current filters, or no logs have been submitted yet.</p>
        <button class="btn btn-primary modern-btn" id="clearFiltersFromEmpty">
            <i class="bi bi-funnel me-2"></i>Clear Filters
        </button>
    </div>

    <!-- Logs Container -->
    <div class="logs-container">
        <div class="row g-4" id="logsContainer">
            @foreach (var log in Model)
            {
                <div class="col-lg-6 col-xl-4 log-item" data-status="@(log.IsReviewed ? "reviewed" : "pending")" 
                     data-client="@log.Client?.User.FullName" data-date="@log.LogDate.ToString("yyyy-MM-dd")" 
                     data-notes="@log.ClientNotes">
                    <div class="log-card modern-log-card @(log.IsReviewed ? "reviewed" : "pending")">
                        <!-- Card Header -->
                        <div class="log-card-header">
                            <div class="d-flex align-items-center gap-3">
                                <div class="client-avatar">
                                    @if (!string.IsNullOrEmpty(log.Client?.User.ImagePath))
                                    {
                                        <img src="@log.Client.User.ImagePath" alt="@log.Client.User.FullName" class="avatar-img">
                                    }
                                    else
                                    {
                                        <div class="avatar-placeholder">
                                            <i class="bi bi-person"></i>
                                        </div>
                                    }
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="client-name mb-1">@log.Client?.User.FullName</h5>
                                    <p class="log-date mb-0">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        @log.LogDate.ToString("MMM dd, yyyy")
                                    </p>
                                </div>
                                <span class="status-badge @(log.IsReviewed ? "status-reviewed" : "status-pending")">
                                    <i class="bi bi-@(log.IsReviewed ? "check-circle" : "clock") me-1"></i>
                                    @(log.IsReviewed ? "Reviewed" : "Pending")
                                </span>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="log-card-body">
                            <!-- Weight Info -->
                            <div class="metric-row mb-3">
                                <div class="metric-item">
                                    <div class="metric-icon">
                                        <i class="bi bi-speedometer2"></i>
                                    </div>
                                    <div class="metric-content">
                                        <div class="metric-value">@log.CurrentWeight kg</div>
                                        <div class="metric-label">Current Weight</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Client Notes -->
                            @if (!string.IsNullOrEmpty(log.ClientNotes))
                            {
                                <div class="notes-section mb-3">
                                    <h6 class="notes-title">
                                        <i class="bi bi-chat-left-text me-2"></i>Client Notes
                                    </h6>
                                    <div class="notes-content">
                                        @log.ClientNotes
                                    </div>
                                </div>
                            }

                            <!-- Photo -->
                            @if (!string.IsNullOrEmpty(log.PhotoPath))
                            {
                                <div class="photo-section mb-3">
                                    <h6 class="photo-title">
                                        <i class="bi bi-camera me-2"></i>Progress Photo
                                    </h6>
                                    <div class="photo-container">
                                        <img src="@log.PhotoPath" alt="Daily Photo" class="progress-photo" 
                                             onclick="openPhotoModal('@log.PhotoPath', '@log.Client?.User.FullName', '@log.LogDate.ToString("MMM dd, yyyy")')">
                                        <div class="photo-overlay">
                                            <i class="bi bi-zoom-in"></i>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Card Footer -->
                        <div class="log-card-footer">
                            @if (!log.IsReviewed)
                            {
                                <form asp-action="ReviewLog" method="post" class="review-form">
                                    <input type="hidden" name="id" value="@log.Id" />
                                    
                                    <div class="form-group mb-3">
                                        <label class="form-label modern-form-label">
                                            <i class="bi bi-chat-dots me-2"></i>Your Feedback
                                        </label>
                                        <textarea name="feedback" class="form-control modern-form-control" rows="3"
                                                  placeholder="Write your feedback and encouragement..." required></textarea>
                                    </div>
                                    
                                    <div class="form-group mb-3">
                                        <label class="form-label modern-form-label">
                                            <i class="bi bi-star me-2"></i>Rating (1-5)
                                        </label>
                                        <div class="rating-input">
                                            <select name="rating" class="form-select modern-form-control" required>
                                                <option value="">Select Rating</option>
                                                <option value="1">⭐ 1 - Needs Improvement</option>
                                                <option value="2">⭐⭐ 2 - Fair</option>
                                                <option value="3">⭐⭐⭐ 3 - Good</option>
                                                <option value="4">⭐⭐⭐⭐ 4 - Very Good</option>
                                                <option value="5">⭐⭐⭐⭐⭐ 5 - Excellent</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success modern-btn w-100">
                                        <i class="bi bi-send me-2"></i>Submit Review
                                    </button>
                                </form>
                            }
                            else
                            {
                                <div class="coach-response">
                                    <div class="response-header">
                                        <h6 class="response-title">
                                            <i class="bi bi-person-check me-2"></i>Your Response
                                        </h6>
                                        <div class="response-rating">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="bi bi-star@(i <= log.CoachRating ? "-fill" : "") star-icon @(i <= log.CoachRating ? "active" : "")"></i>
                                            }
                                        </div>
                                    </div>
                                    <div class="response-content">
                                        @log.CoachFeedback
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header modern-modal-header">
                <div class="modal-title-wrapper">
                    <div class="modal-icon">
                        <i class="bi bi-camera"></i>
                    </div>
                    <div class="modal-title-content">
                        <h5 class="modal-title" id="photoModalLabel">Progress Photo</h5>
                        <p class="modal-subtitle" id="photoModalSubtitle">Client progress image</p>
                    </div>
                </div>
                <button type="button" class="btn-close modern-btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="modalPhoto" src="" alt="Progress Photo" class="img-fluid">
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Global variables for filtering and view management
        let allLogs = [];
        let filteredLogs = [];
        let currentView = 'card';
        let currentFilter = 'all';

        document.addEventListener("DOMContentLoaded", function () {
            // Initialize the page
            initializeLogsPage();
            setupEventHandlers();
            
            // Handle success/error messages
            var successMessage = '@TempData["SuccessMessage"]';
            var errorMessage = '@TempData["ErrorMessage"]';

            if (successMessage && successMessage.length > 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'Review Submitted',
                    text: successMessage,
                    confirmButtonColor: '#3085d6',
                    timer: 2500,
                    timerProgressBar: true
                });
            }

            if (errorMessage && errorMessage.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMessage,
                    confirmButtonColor: '#d33',
                });
            }
        });

        function initializeLogsPage() {
            // Initialize logs array from DOM
            allLogs = Array.from(document.querySelectorAll('.log-item')).map(item => ({
                element: item,
                status: item.dataset.status,
                client: item.dataset.client,
                date: item.dataset.date,
                notes: item.dataset.notes
            }));
            filteredLogs = [...allLogs];
        }

        function setupEventHandlers() {
            // Refresh button
            document.getElementById('refreshLogsBtn').addEventListener('click', function() {
                location.reload();
            });

            // Search functionality
            document.getElementById('logSearchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterLogs(searchTerm);
            });

            // Status filter
            document.getElementById('statusFilter').addEventListener('change', function() {
                const searchTerm = document.getElementById('logSearchInput').value.toLowerCase();
                filterLogs(searchTerm);
            });

            // Filter dropdown
            document.querySelectorAll('.dropdown-item[data-filter]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentFilter = this.dataset.filter;
                    const searchTerm = document.getElementById('logSearchInput').value.toLowerCase();
                    filterLogs(searchTerm);
                });
            });

            // Clear filters
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('clearFiltersFromEmpty').addEventListener('click', clearFilters);

            // View toggle
            document.getElementById('cardViewBtn').addEventListener('click', function() {
                currentView = 'card';
                this.classList.add('btn-primary');
                this.classList.remove('btn-outline-primary');
                document.getElementById('listViewBtn').classList.add('btn-outline-primary');
                document.getElementById('listViewBtn').classList.remove('btn-primary');
                renderLogs(filteredLogs);
            });

            document.getElementById('listViewBtn').addEventListener('click', function() {
                currentView = 'list';
                this.classList.add('btn-primary');
                this.classList.remove('btn-outline-primary');
                document.getElementById('cardViewBtn').classList.add('btn-outline-primary');
                document.getElementById('cardViewBtn').classList.remove('btn-primary');
                renderLogs(filteredLogs);
            });
        }

        function filterLogs(searchTerm = '') {
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredLogs = allLogs.filter(log => {
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    log.client.toLowerCase().includes(searchTerm) ||
                    log.notes.toLowerCase().includes(searchTerm) ||
                    log.date.includes(searchTerm);
                
                // Status filter
                const matchesStatus = statusFilter === '' || log.status === statusFilter;
                
                // Dropdown filter
                const matchesDropdown = currentFilter === 'all' || 
                    (currentFilter === 'pending' && log.status === 'pending') ||
                    (currentFilter === 'reviewed' && log.status === 'reviewed');
                
                return matchesSearch && matchesStatus && matchesDropdown;
            });
            
            renderLogs(filteredLogs);
        }

        function renderLogs(logs) {
            const container = document.getElementById('logsContainer');
            const emptyState = document.getElementById('emptyState');
            const logsContainer = document.querySelector('.logs-container');
            
            // Hide all log items first
            allLogs.forEach(log => {
                log.element.style.display = 'none';
            });
            
            if (logs.length === 0) {
                logsContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            logsContainer.style.display = 'block';
            
            // Show filtered logs
            logs.forEach(log => {
                if (currentView === 'list') {
                    log.element.className = 'col-12 log-item';
                    log.element.querySelector('.log-card').classList.add('list-view');
                } else {
                    log.element.className = 'col-lg-6 col-xl-4 log-item';
                    log.element.querySelector('.log-card').classList.remove('list-view');
                }
                log.element.style.display = 'block';
            });
        }

        function clearFilters() {
            document.getElementById('logSearchInput').value = '';
            document.getElementById('statusFilter').value = '';
            currentFilter = 'all';
            filterLogs('');
        }

        // Photo modal functionality
        function openPhotoModal(photoPath, clientName, date) {
            document.getElementById('modalPhoto').src = photoPath;
            document.getElementById('photoModalLabel').textContent = clientName + ' - Progress Photo';
            document.getElementById('photoModalSubtitle').textContent = date;
            
            const modal = new bootstrap.Modal(document.getElementById('photoModal'));
            modal.show();
        }

        // Make function globally available
        window.openPhotoModal = openPhotoModal;

        // Form submission enhancement
        document.querySelectorAll('.review-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Submitting...';
                
                // Re-enable button after a delay if form submission fails
                setTimeout(() => {
                    if (submitBtn.disabled) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                }, 5000);
            });
        });
    </script>
}
