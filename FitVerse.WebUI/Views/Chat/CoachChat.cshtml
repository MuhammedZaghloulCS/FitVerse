
@{
    ViewData["Title"] = "CoachChat";
    Layout = "~/Views/Shared/_CoachLayout.cshtml";
}

<!-- Main Content -->
<div class="container-fluid px-4 py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">
                <i class="bi bi-chat-dots me-2 text-primary"></i>Messages
            </h2>
            <p class="text-muted mb-0">Communicate with your clients in real-time</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary modern-btn" id="refreshChatsBtn">
                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </button>
            <div class="dropdown">
                <button class="btn btn-secondary modern-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-funnel me-2"></i>Filter
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-filter="all">All Conversations</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="unread">Unread Messages</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="online">Online Clients</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="row g-3">
        <!-- Conversations List -->
        <div class="col-lg-4 col-xl-3">
            <div class="conversations-panel">
                <!-- Search Bar -->
                <div class="conversations-search">
                    <div class="search-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" id="conversationSearch" class="form-control modern-search-input" 
                               placeholder="Search conversations...">
                    </div>
                </div>

                <!-- Conversations List -->
                <div id="conversationsList" class="conversations-list">
                    <!-- Active Chats Section -->
                    <div id="activeChatsSection">
                        <!-- This will be populated by JavaScript -->
                    </div>
                    
                    <!-- Available Clients Section -->
                    <div class="section-header">
                        <h6 class="section-title">
                            <i class="bi bi-people me-2"></i>Available Clients
                        </h6>
                    </div>
                    
                    <div class="clients-list">
                        @if (ViewBag.AvailableClients != null)
                        {
                            @foreach (var client in (IEnumerable<FitVerse.Data.Models.Client>)ViewBag.AvailableClients)
                            {
                                <div class="client-item" data-client-id="@client.UserId" data-client-name="@client.User.FullName">
                                    <div class="client-content">
                                        <div class="client-avatar-wrapper">
                                            <div class="client-avatar">
                                                <img src="@(string.IsNullOrEmpty(client.User.ImagePath) ? $"https://ui-avatars.com/api/?name={client.User.FullName}&background=6366f1&color=fff" : client.User.ImagePath)" 
                                                     alt="@client.User.FullName" class="avatar-img">
                                                <span class="status-indicator @(client.User.Status == "Active" ? "online" : "offline")"></span>
                                            </div>
                                        </div>
                                        <div class="client-info">
                                            <div class="client-header">
                                                <h6 class="client-name">@client.User.FullName</h6>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary btn-sm start-chat-btn" data-client-id="@client.UserId">
                                            <i class="bi bi-chat-dots"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="col-lg-8 col-xl-9">
            <div class="modern-chat-container">
                <!-- Chat Header -->
                <div id="chatHeader" class="modern-chat-header" style="display: none;">
                    <!-- This will be populated dynamically when a chat is selected -->
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="modern-chat-messages">
                    <div class="chat-welcome-state">
                        <div class="welcome-icon">
                            <i class="bi bi-chat-dots"></i>
                        </div>
                        <h4 class="welcome-title">Welcome to FitVerse Chat</h4>
                        <p class="welcome-subtitle">Select a conversation or start a new chat with your clients</p>
                        <div class="welcome-features">
                            <div class="feature-item">
                                <i class="bi bi-lightning-charge"></i>
                                <span>Real-time messaging</span>
                            </div>
                            <div class="feature-item">
                                <i class="bi bi-check-circle"></i>
                                <span>Read receipts</span>
                            </div>
                            <div class="feature-item">
                                <i class="bi bi-three-dots"></i>
                                <span>Typing indicators</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="modern-chat-input">
                    <div class="chat-input-wrapper">
                        <button class="btn btn-light modern-btn-icon" title="Attach file">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <button class="btn btn-light modern-btn-icon" title="Add emoji">
                            <i class="bi bi-emoji-smile"></i>
                        </button>
                        <div class="message-input-wrapper">
                            <input type="text" id="messageInput" placeholder="Type your message..." 
                                   class="form-control modern-message-input">
                            <div class="typing-indicator-small" id="typingIndicatorSmall" style="display: none;">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                        <button id="sendButton" class="modern-send-btn">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@section Scripts {
    <script src="https://unpkg.com/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script>
        let connection;
        let currentChatId = null;
        let currentUserId = '@ViewBag.UserId';
        let currentReceiverId = null;
        let typingTimer;

        // Initialize SignalR connection
        function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .build();

            connection.start().then(() => {
                console.log("SignalR Connected");
                loadUserChats();
            }).catch(err => console.error("SignalR Connection Error: ", err));

            // Handle incoming messages
            connection.on("ReceiveMessage", messageData => {
                console.log('Received message:', messageData);
                if (messageData.ChatId == currentChatId) {
                    appendMessage(messageData);
                    scrollToBottom();
                }
                updateConversationsList();
            });

            // Handle message read status
            connection.on("MessageRead", messageId => {
                markMessageAsRead(messageId);
            });

            // Handle typing indicators (no more chatId)
            connection.on("UserTyping", senderId => {
                if (senderId !== currentUserId && senderId === currentReceiverId) {
                    showTypingIndicator();
                }
            });

            connection.on("UserStoppedTyping", senderId => {
                if (senderId !== currentUserId && senderId === currentReceiverId) {
                    hideTypingIndicator();
                }
            });

            // Handle online/offline status
            connection.on("UserOnline", userId => updateUserStatus(userId, true));
            connection.on("UserOffline", userId => updateUserStatus(userId, false));
        }

        // Load chats
        function loadUserChats() {
            fetch('/Chat/GetUserChats')
                .then(r => r.json())
                .then(displayChats)
                .catch(err => console.error('Error loading chats:', err));
        }

        // Display chat list
        function displayChats(chats) {
            const section = document.getElementById('activeChatsSection');
            section.innerHTML = '';

            if (chats?.length) {
                // Create header with chat count
                const header = document.createElement('div');
                header.className = 'section-header';
                header.innerHTML = `<h6 class="section-title"><i class="bi bi-chat-left-dots me-2"></i>Active Chats (${chats.length})</h6>`;
                section.appendChild(header);

                // Sort chats by latest message time and unread status
                const sortedChats = chats.sort((a, b) => {
                    // Prioritize unread chats
                    if (a.UnreadCount > 0 && b.UnreadCount === 0) return -1;
                    if (a.UnreadCount === 0 && b.UnreadCount > 0) return 1;
                    
                    // Then sort by latest message time
                    return new Date(b.LatestMessageTime) - new Date(a.LatestMessageTime);
                });

                // Create chat elements with staggered animation
                sortedChats.forEach((chat, index) => {
                    const el = createChatElement(chat);
                    el.style.animationDelay = `${index * 50}ms`;
                    el.classList.add('chat-item-enter');
                    section.appendChild(el);
                });
            } else {
                // Show empty state
                const emptyState = document.createElement('div');
                emptyState.className = 'active-chats-empty';
                emptyState.innerHTML = `
                    <i class="bi bi-chat-dots"></i>
                    <p>No active conversations yet</p>
                    <small>Start a conversation with your clients</small>
                `;
                section.appendChild(emptyState);
            }
        }

        // Chat item
        function createChatElement(chat) {
            const div = document.createElement('div');
            div.className = 'chat-item modern-chat-item';
            div.dataset.chatId = chat.Id;
            div.dataset.receiverId = chat.OtherUserId;
            div.dataset.userName = chat.OtherUserName;
            div.setAttribute('tabindex', '0');
            div.setAttribute('role', 'button');
            div.setAttribute('aria-label', `Chat with ${chat.OtherUserName}`);

            // Enhanced unread badge with count-based styling
            let unreadBadge = '';
            if (chat.UnreadCount > 0) {
                const badgeClass = chat.UnreadCount > 9 ? 'high-count' : 
                                 chat.UnreadCount > 3 ? 'medium-count' : '';
                const displayCount = chat.UnreadCount > 99 ? '99+' : chat.UnreadCount;
                unreadBadge = `<span class="unread-badge ${badgeClass}">${displayCount}</span>`;
            }

            // Enhanced time display
            const timeClass = isRecentMessage(chat.LatestMessageTime) ? 'recent' : '';
            const formattedTime = formatMessageTime(chat.LatestMessageTime);

            // Message preview with type detection
            const messagePreview = formatMessagePreview(chat.LatestMessage);

            // User name with proper formatting
            const displayName = formatUserName(chat.OtherUserName);

            div.innerHTML = `
                <div class="chat-content">
                    <div class="chat-avatar-wrapper">
                        <div class="chat-avatar">
                            <img src="${chat.OtherUserAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=6366f1&color=fff`}" 
                                 alt="${displayName}" 
                                 class="avatar-img"
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=6366f1&color=fff'">
                            <span class="status-indicator ${chat.IsOnline ? 'online' : 'offline'}"></span>
                        </div>
                    </div>
                    <div class="chat-info">
                        <h6 class="chat-name">${displayName}</h6>
                        <p class="chat-message">${messagePreview}</p>
                    </div>
                    ${unreadBadge}
                </div>
            `;

            // Enhanced event listeners
            div.addEventListener('click', () => selectChat(chat.Id, chat.OtherUserId, displayName));
            div.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    selectChat(chat.Id, chat.OtherUserId, displayName);
                }
            });

            // Add hover effects for better UX
            div.addEventListener('mouseenter', () => {
                if (!div.classList.contains('active')) {
                    div.style.transform = 'translateY(-2px) translateX(4px)';
                }
            });

            div.addEventListener('mouseleave', () => {
                if (!div.classList.contains('active')) {
                    div.style.transform = '';
                }
            });

            return div;
        }

        // Helper function to check if message is recent (within last hour)
        function isRecentMessage(messageTime) {
            const now = new Date();
            const msgTime = new Date(messageTime);
            const diffInMinutes = (now - msgTime) / (1000 * 60);
            return diffInMinutes < 60;
        }

        // Helper function to format message time
        function formatMessageTime(messageTime) {
            const now = new Date();
            const msgTime = new Date(messageTime);
            const diffInMinutes = (now - msgTime) / (1000 * 60);
            
            if (diffInMinutes < 1) return 'now';
            if (diffInMinutes < 60) return `${Math.floor(diffInMinutes)}m`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h`;
            return `${Math.floor(diffInMinutes / 1440)}d`;
        }

        // Helper function to format message preview
        function formatMessagePreview(message) {
            if (!message) return 'No messages yet';
            
            // Detect message types and add icons
            if (message.includes('ðŸ“·') || message.toLowerCase().includes('photo') || message.toLowerCase().includes('image')) {
                return '<span class="has-image">ðŸ“· Photo</span>';
            }
            if (message.includes('ðŸ“Ž') || message.toLowerCase().includes('file') || message.toLowerCase().includes('document')) {
                return '<span class="has-file">ðŸ“Ž File</span>';
            }
            
            // Truncate long messages
            return message.length > 50 ? message.substring(0, 50) + '...' : message;
        }

        // Helper function to format user name (ensure proper capitalization)
        function formatUserName(userName) {
            if (!userName) return 'Unknown User';
            
            // Handle email addresses - extract name part before 
            if (userName.includes('@@')) {
                userName = userName.split('@@')[0];
            }
            
            // Capitalize first letter of each word
            return userName.split(' ')
                          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                          .join(' ');
        }

        // Helper function to get message type for styling
        function getMessageType(message) {
            if (!message) return 'empty';
            
            if (message.includes('ðŸ“·') || message.toLowerCase().includes('photo') || message.toLowerCase().includes('image')) {
                return 'image';
            }
            if (message.includes('ðŸ“Ž') || message.toLowerCase().includes('file') || message.toLowerCase().includes('document')) {
                return 'file';
            }
            if (message.toLowerCase().includes('typing') || message.includes('âœï¸')) {
                return 'typing';
            }
            
            return 'text';
        }

        // Select chat
        function selectChat(chatId, receiverId, receiverName) {
            currentChatId = chatId;
            currentReceiverId = receiverId;

            updateChatHeader(receiverName, receiverId);
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');

            loadChatMessages(chatId);
            markChatAsRead(chatId);
        }

        // Load chat messages
        function loadChatMessages(chatId) {
            fetch(`/Chat/GetChatMessages?chatId=${chatId}`)
                .then(r => r.json())
                .then(messages => {
                    displayMessages(messages);
                    scrollToBottom();
                })
                .catch(err => console.error('Error loading messages:', err));
        }

        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = `<div class="text-center my-3"><span class="badge bg-secondary">Today</span></div>`;
            messages.forEach(m => appendMessage(m));
        }

        function appendMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            const isCurrentUser = message.SenderId === currentUserId || message.IsCurrentUser;

            div.className = `message-bubble ${isCurrentUser ? 'sent' : 'received'}`;
            div.innerHTML = `
                <div class="message-content">${message.Content}</div>
                <div class="message-time ${isCurrentUser ? 'text-end' : ''}">${message.SentAt}</div>
            `;
            chatMessages.appendChild(div);
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message && currentChatId && currentReceiverId) {
                connection.invoke("SendMessage", currentChatId.toString(), currentReceiverId, message)
                    .catch(err => console.error('Error sending message:', err));

                input.value = '';
                stopTyping();
            }
        }

        // Typing events
        function startTyping() {
            if (currentReceiverId) {
                connection.invoke("UserTyping", currentReceiverId);
            }
        }

        function stopTyping() {
            if (currentReceiverId) {
                connection.invoke("UserStoppedTyping", currentReceiverId);
            }
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            if (!document.getElementById('typingIndicator')) {
                const div = document.createElement('div');
                div.id = 'typingIndicator';
                div.className = 'message-bubble received';
                div.innerHTML = `
                    <div class="message-content">
                        <div class="d-flex gap-1">
                            <span class="spinner-grow spinner-grow-sm" style="width:8px;height:8px;"></span>
                            <span class="spinner-grow spinner-grow-sm" style="width:8px;height:8px;"></span>
                            <span class="spinner-grow spinner-grow-sm" style="width:8px;height:8px;"></span>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(div);
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function updateChatHeader(receiverName, receiverId) {
            const header = document.getElementById('chatHeader');
            header.innerHTML = `
                <div class="chat-header-content">
                    <div class="header-user-info">
                        <div class="header-avatar">
                            <img src="https://ui-avatars.com/api/?name=${receiverName}&background=6366f1&color=fff" 
                                 alt="${receiverName}" class="avatar-img">
                            <span class="status-indicator online"></span>
                        </div>
                        <div class="user-details">
                            <h6 class="user-name">${receiverName}</h6>
                            <p class="user-status">Client â€¢ Online</p>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-light modern-btn-icon" title="Voice call">
                            <i class="bi bi-telephone"></i>
                        </button>
                        <button class="btn btn-light modern-btn-icon" title="Video call">
                            <i class="bi bi-camera-video"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-light modern-btn-icon dropdown-toggle" type="button" data-bs-toggle="dropdown" title="More options">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>View Profile</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-bell me-2"></i>Notifications</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash me-2"></i>Clear Chat</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            header.style.display = 'block';
        }

        function markChatAsRead(chatId) {
            fetch('/Chat/MarkAsRead', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({ chatId })
            });
        }

        function markMessageAsRead(messageId) {
            console.log(`Message ${messageId} marked as read`);
        }

        function updateUserStatus(userId, isOnline) {
            document.querySelectorAll(`[data-receiver-id="${userId}"] .user-status`)
                .forEach(el => el.style.background = isOnline ? '#10b981' : '#94a3b8');
        }

        function updateConversationsList() {
            loadUserChats();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeSignalR();
            setupEventHandlers();
        });

        function setupEventHandlers() {
            // Send button and Enter key
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });

            // Typing indicators
            document.getElementById('messageInput').addEventListener('input', () => {
                startTyping();
                clearTimeout(typingTimer);
                typingTimer = setTimeout(stopTyping, 1000);
            });

            // Start chat buttons
            document.querySelectorAll('.start-chat-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const clientId = btn.getAttribute('data-client-id');
                    startChatWithUser(clientId);
                });
            });

            // Refresh chats button
            document.getElementById('refreshChatsBtn').addEventListener('click', () => {
                loadUserChats();
            });

            // Conversation search
            document.getElementById('conversationSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterConversations(searchTerm);
            });

            // Filter dropdown
            document.querySelectorAll('.dropdown-item[data-filter]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const filter = this.dataset.filter;
                    applyConversationFilter(filter);
                });
            });

            // Client item clicks
            document.querySelectorAll('.client-item').forEach(item => {
                item.addEventListener('click', function() {
                    const clientId = this.dataset.clientId;
                    const clientName = this.dataset.clientName;
                    startChatWithUser(clientId);
                });
            });
        }

        function filterConversations(searchTerm) {
            const chatItems = document.querySelectorAll('.chat-item');
            const clientItems = document.querySelectorAll('.client-item');
            
            // Filter active chats
            chatItems.forEach(item => {
                const chatName = item.querySelector('.chat-name')?.textContent.toLowerCase() || '';
                const chatMessage = item.querySelector('.chat-message')?.textContent.toLowerCase() || '';
                
                if (chatName.includes(searchTerm) || chatMessage.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Filter available clients
            clientItems.forEach(item => {
                const clientName = item.querySelector('.client-name')?.textContent.toLowerCase() || '';
                const clientGoal = item.querySelector('.client-goal')?.textContent.toLowerCase() || '';
                
                if (clientName.includes(searchTerm) || clientGoal.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function applyConversationFilter(filter) {
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const unreadBadge = item.querySelector('.unread-badge');
                const isOnline = item.querySelector('.status-indicator.online');
                
                switch(filter) {
                    case 'unread':
                        item.style.display = unreadBadge ? 'block' : 'none';
                        break;
                    case 'online':
                        item.style.display = isOnline ? 'block' : 'none';
                        break;
                    default:
                        item.style.display = 'block';
                }
            });
        }

        function startChatWithUser(otherUserId) {
            fetch('/Chat/CreateChat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({ OtherUserId: otherUserId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadUserChats();
                    selectChat(data.chatId, otherUserId, data.otherUserName);
                } else {
                    console.error('Error creating chat:', data.message);
                }
            })
            .catch(err => console.error('Error starting chat:', err));
        }
    </script>
}


